---
title: "Final_Version_Data_Viz"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: cosmo
    orientation: rows
---

```{r, error = TRUE, message=FALSE, warning=FALSE, include=FALSE}

rm(list=ls())
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(magrittr)
library(rvest)
library(tidyverse)
library(leaflet)
library(RColorBrewer)
library(plotly)
library(readr)
library(tidyquant)
library(urbnmapr)
library(tmap)
library(sf)
library(stringr)
library(tigris)
library(rgdal)
library(WDI)
library(highcharter)
library(rworldmap)
library(tidyr)
library(igraph)
library(networkD3)
```

Overview
===================================== 
### Project Topic: Debt Levels 

This is our final project for QMSS 5063: Data Visualization (Columbia University, Spring 2021).   
Members: Luke Artola, Samantha Li, Yun Yee Tan (Group K)

With the rise of COVID-19, governments around the world have drastically increased their amount of debt. Within the developed countries, the US' debt-to-GDP ratio has now become 102% and Japan has skyrocketed to 234%, which are staggering numbers. The developing countries have been hit with an even harder blow. Given this renewed interest and concern over debt levels, we decided to gear our project towards providing information that might be of interest to those who work on fiscal and economic development policy.

We will be examining government debt from a few different levels:
1. First, we will look at national debt within the US and how debt levels vary across states.
2. Next, we will zoom out on a global level to explore the geographical distribution of debt as well as its relationship with the Human Development Index.
3. Finally, we will explore international debt flows and the network between debtor and creditor nations.


Global Debt
===================================== 
### Covid Debt Surge

```{r}
data <- read.csv("covid.csv")
data <- data %>%
  rename(Country = "X")


p <- ggplot(data = data, aes( x = Country, y = Debt_Increase)) +
  geom_bar(stat = "identity", fill = "dodgerblue1") +
  geom_text(aes(label=Debt_Increase), vjust = .5, hjust = 2, color="black", size=5) +
  scale_x_discrete(limits=c("China","France", "Spain", "United Kingdom", "Japan", "United States", "Canada")) +
  ggtitle("Debt to GDP Change in 2020") +
  xlab("Country") +
  labs(caption = "Bloomberg, IFF") +
  ylab("Percent Increase") +
  coord_flip() +
  theme_classic()

p +  theme(axis.text.x = element_text(face = "bold", colour = "black")) +
  theme(axis.text.y = element_text(face = "bold", colour = "black")) 

```

### US National Debt

```{r}
d = read.csv("debt.csv")
us_debt = read.csv("federal_debt_trends.csv") 

usa = us_debt
usa = select(us_debt, year, federal_debt, gdp,debt_gdp)

# dot-and-line chart


usa_chart <- ggplot(usa, aes(x = year, y = debt_gdp,
                                             text = paste0("<b>Year: </b>", year,"<br>",
                                                           "<b>Debt: </b>", federal_debt," dollars<br>",
                                                           "<b>GDP: </b> $", gdp, " dollars<br>",
                                                          "<b>Debt GDP ratio: </b> ", debt_gdp, "(ratio)"),
                                             group = 1)) +
  xlab("Year") +
  ylab("Dollars ($)") +
  theme_minimal(base_size = 14, base_family = "Georgia") +
  geom_point() +
  geom_line()

usa_chart_interactive <- ggplotly(usa_chart, tooltip = "text") %>% 
  config(displayModeBar = FALSE) %>%
  layout(hoverlabel = list(bgcolor = "white",
                           font = list(family = "Georgia")))

usa_chart_interactive <- usa_chart_interactive %>% layout(title = 'US Debt to GDP Ratio')

print(usa_chart_interactive)

```

### US State Debt
```{r}
data <- read.csv("state_2020.csv") 
data_1 <- data %>%
  select(State, Debt.Ratio..Total.Debts.Total.Assets) %>%
  rename("Debt_Level" = "Debt.Ratio..Total.Debts.Total.Assets")

#Debt was recorded as a character, converted to numeric
data_1$Debt_Level <- str_remove_all(string = data_1$Debt_Level, pattern = "%")
data_1$Debt_Level <- as.numeric(data_1$Debt_Level)



# removing DC as it is a district
states_sf <- get_urbn_map("states", sf = TRUE)
states_sf <- states_sf %>%
  filter(state_abbv != "DC")

states_sf <- states_sf %>%
  rename(State = "state_name")

state_debt <- left_join(data_1, states_sf, by = "State")
#head(state_debt)

state_debt <- st_as_sf(state_debt)


position <- c("center", "top")
tm_shape(state_debt) + 
  tm_polygons(col = "Debt_Level", title = "Debt Level", palette = "Purples", breaks = c(0,25,50,75, 100, 150,200,300,400, 500)) +
  tm_text(text = "state_abbv", size = .75, remove.overlap = TRUE) +
  tm_legend(scale = .80) + 
  tm_layout(title = "State Debt Levels 2020 (%)", title.position = position) 


```

HDI 
===================================== 

Row {data-height=650}
-------------------------------------

### HDI 2015 Chloropleth

```{r}
hdi = read.csv("human-development-index-escosura.csv")
hdiworld = hdi
#hdi

hdiworld <- hdiworld %>%
  filter(Year == 2015) %>%
  select(Entity, Historical.Index.of.Human.Development..Prados.de.la.Escosura.)  
#hdiworld
colnames(hdiworld)[colnames(hdiworld) == "Historical.Index.of.Human.Development..Prados.de.la.Escosura."] <- "HDI"
# Load required R packages


# Set highcharter options
options(highcharter.theme = hc_theme_smpl(tooltip = list(valueDecimals = 2)))

# Load the world Map data
data(worldgeojson, package = "highcharter")

#worldgeojson
hdiworld2 <-hdi
hdiworld2 <- hdiworld2 %>%
  filter(Year == 2015) %>%
  select(Code, Historical.Index.of.Human.Development..Prados.de.la.Escosura.)  

#hdiworld2
colnames(hdiworld2)[colnames(hdiworld2) == "Historical.Index.of.Human.Development..Prados.de.la.Escosura."] <- "HDI"

hc2 <- highchart() %>%
  hc_add_series_map(
    worldgeojson, hdiworld2, value = "HDI", joinBy = c('iso3','Code'),
    name = "HumanDevelopmentIndex"
    )  %>% 
  hc_colorAxis(stops = color_stops()) %>% 
  hc_title(text = "World Map") %>% 
  hc_subtitle(text = "HDI in 2015")

hc2
```

Row {data-height=350}
-------------------------------------

### Chart HDI Line Graph by Country

```{r}
# create interactive line chart
graph3 = hdi

graph3 <- graph3 %>%
  select(Year, Entity, Historical.Index.of.Human.Development..Prados.de.la.Escosura.)  

colnames(graph3)[colnames(graph3) == "Historical.Index.of.Human.Development..Prados.de.la.Escosura."] <- "HDI"
#graph3

plotdata <- spread(graph3, Entity, HDI)

h <- highchart() %>% 
  hc_xAxis(categories = plotdata$Year) %>% 
  hc_add_series(name = "Argentina", 
                data = plotdata$Argentina) %>% 
  hc_add_series(name = "China", 
                data = plotdata$China) %>%
  hc_add_series(name = "India", 
                data = plotdata$India) %>%
  hc_add_series(name = "Peru", 
                data = plotdata$Peru) %>%
  hc_add_series(name = "United States of America", 
                data = plotdata$"United States") 

h <- h %>%
  hc_title(text = "HDI by Country",
           margin = 20, 
           align = "left",
           style = list(color = "steelblue")) %>% 
  hc_subtitle(text = "1870 to 2015",
              align = "left",
              style = list(color = "#2b908f", 
                           fontWeight = "bold")) %>% 
  hc_credits(enabled = TRUE, # add credits
             text = "United Nations HDI") %>% 
  hc_legend(align = "left", 
            verticalAlign = "top",
            layout = "vertical", 
            x = 0, 
            y = 100) %>%
  hc_tooltip(crosshairs = TRUE, 
             backgroundColor = "#FCFFC5",
             shared = TRUE, 
             borderWidth = 4) %>% 
  hc_exporting(enabled = TRUE)

h


```


```{r, warning=FALSE, message=FALSE}
world_debt = read_csv("world_debt - Sheet1.csv")
world_debt[world_debt == "no data"] <- NA
df_transpose = as.data.frame(t(world_debt))
names(df_transpose) <- lapply(df_transpose[1, ], as.character)
df_transpose <- df_transpose[-1,] 
```


### Chart Debt:GDP Ratio by Country 

```{r}
world_debt_gdp_ratio = df_transpose
# generate graph
#Finding debt over time for:
#Argentina
#China
#India
#Peru
#US
world_debt_gdp_ratio = world_debt_gdp_ratio[2:48,] %>% mutate_if(is.character,as.double)

world_debt_gdp_ratio$Year = row.names(world_debt_gdp_ratio)

w <- highchart() %>% 
  hc_xAxis(categories = world_debt_gdp_ratio$Year) %>% 
  hc_add_series(name = "Argentina", 
                data = world_debt_gdp_ratio$Argentina,
                color = "#D55400") %>% 
  hc_add_series(name = "China", 
                data = world_debt_gdp_ratio$"China, People's Republic of",
                color = "#227FBB") %>% 
  hc_add_series(name = "India", 
                data = world_debt_gdp_ratio$India,
                color = "#1ECE6D") %>% 
  hc_add_series(name = "Peru", 
                data = world_debt_gdp_ratio$Peru,
                color = "#F2C500") %>% 
  hc_add_series(name = "United States of America", 
                data = world_debt_gdp_ratio$"United States",
                color= '#2B3E51') 


w

# customize interactive line chart
w <- w %>%
  hc_title(text = "Debt:GDP Ratio by Country",
           margin = 20, 
           align = "left",
           style = list(color = "steelblue")) %>% 
  hc_subtitle(text = "1980 to 2025",
              align = "left",
              style = list(color = "#2b908f", 
                           fontWeight = "bold")) %>% 
  hc_credits(enabled = TRUE, # add credits
             text = "IMF") %>% 
  hc_legend(align = "left", 
            verticalAlign = "top",
            layout = "vertical", 
            x = 0, 
            y = 100) %>%
  hc_tooltip(crosshairs = TRUE, 
             backgroundColor = "#FCFFC5",
             shared = TRUE, 
             borderWidth = 4) %>% 
  hc_exporting(enabled = TRUE)

w


```


-------------------------------------
### NAME
```{r}
w2 <- highchart() %>% 
  hc_xAxis(categories = world_debt_gdp_ratio$Year) %>% 
  hc_add_series(name = "Advanced Economies", 
                data = world_debt_gdp_ratio$`Advanced economies`) %>%
  hc_add_series(name = "Developing Countries", 
                data = world_debt_gdp_ratio$`Emerging market and developing economies`) 


w2

# customize interactive line chart
w2 <- w2 %>%
  hc_title(text = "Debt:GDP Ratio by Type",
           margin = 20, 
           align = "left",
           style = list(color = "steelblue")) %>% 
  hc_subtitle(text = "1930 to 2026",
              align = "left",
              style = list(color = "#2b908f", 
                           fontWeight = "bold")) %>% 
  hc_credits(enabled = TRUE, # add credits
             text = "world_debt_gdp_ratio") %>% 
  hc_legend(align = "left", 
            verticalAlign = "top",
            layout = "vertical", 
            x = 0, 
            y = 100) %>%
  hc_tooltip(crosshairs = TRUE, 
             backgroundColor = "#FCFFC5",
             shared = TRUE, 
             borderWidth = 4) %>% 
  hc_exporting(enabled = TRUE)

w2




```

International Debt Flows
===================================== 

```{R, warning=FALSE, message=FALSE}
dssi <- read_csv("dssi_2020.csv")

dssi <- dssi %>% select(-`Series Code`) %>% gather("Year", "Value", 6:9)

dssi <- dssi %>% anti_join(dssi[c(29785, 29786, 29787, 29788, 29789, 59574, 59575, 59576, 59577, 59578, 89363, 89364, 89365, 89366, 89367, 119152, 119153, 119154, 119155, 119156),])

dssi <- dssi %>% spread(`Series Name`, `Value`)

colnames(dssi) <- c("Debtor", "Debtor_Code", "Creditor", "Creditor_Code", "Year", "Debt_Forgiveness", "Debt_Stocks")

dssi$Debt_Forgiveness <- as.numeric(dssi$Debt_Forgiveness)
dssi$Debt_Stocks <- as.numeric(dssi$Debt_Stocks)
dssi$Year <- as.factor(dssi$Year)

dssi[is.na(dssi)] <- 0

dssi$Debtor <- stringr::str_trim(dssi$Debtor, side = "both")
dssi$Creditor <- stringr::str_trim(dssi$Creditor, side = "both")

dssi <- dssi %>% mutate(Debtor_Region = case_when(
  Debtor %in% c("Angola", "Benin", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep.", "Congo, Rep.", "Cote d'Ivoire", "Djibouti", "Ethiopia", "Gambia, The", "Ghana", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Nigeria", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "Tanzania", "Togo", "Uganda", "Zambia") ~ "Africa",
  Debtor %in% c("Bangladesh", "Bhutan", "Cambodia", "Kyrgyz Republic", "Lao PDR", "Maldives", "Mongolia", "Myanmar", "Nepal", "Pakistan", "Tajikistan", "Timor-Leste", "Uzbekistan") ~ "Asia",
  Debtor %in% c("Afghanistan", "Yemen, Rep.") ~ "Middle East",
  Debtor %in% c("Guyana", "Haiti", "Honduras", "Nicaragua") ~ "South & Central America",
  Debtor %in% c("Dominica", "Grenada", "St. Lucia", "St. Vincent and the Grenadines") ~ "The Caribbeans",
  Debtor %in% c("Fiji", "Papua New Guinea", "Samoa", "Solomon Islands", "Tonga", "Vanuatu") ~ "Pacific Islands",
  Debtor %in% c("Kosovo", "Moldova") ~ "Europe"
))


debt_series <- read_csv("debt_series.csv")

debt_series <- debt_series[1:68, c(1, 7:26)]
colnames(debt_series) <- c("Debtor", 2000:2019)
debt_series <- debt_series %>% gather(key = "Year", value = "Debt_Stocks", 2:21)

debt_series$Debt_Stocks <- as.numeric(debt_series$Debt_Stocks)
debt_series$Year <- as.numeric(debt_series$Year)

debt_series[which(is.na(debt_series$Debt_Stocks)), "Debt_Stocks"] <- 0

debt_series <- debt_series %>% mutate(Debtor_Region = case_when(
  Debtor %in% c("Angola", "Benin", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep.", "Congo, Rep.", "Cote d'Ivoire", "Djibouti", "Ethiopia", "Gambia, The", "Ghana", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Nigeria", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "Tanzania", "Togo", "Uganda", "Zambia") ~ "Africa",
  Debtor %in% c("Bangladesh", "Bhutan", "Cambodia", "Kyrgyz Republic", "Lao PDR", "Maldives", "Mongolia", "Myanmar", "Nepal", "Pakistan", "Tajikistan", "Timor-Leste", "Uzbekistan") ~ "Asia",
  Debtor %in% c("Afghanistan", "Yemen, Rep.") ~ "Middle East",
  Debtor %in% c("Guyana", "Haiti", "Honduras", "Nicaragua") ~ "South & Central America",
  Debtor %in% c("Dominica", "Grenada", "St. Lucia", "St. Vincent and the Grenadines") ~ "The Caribbeans",
  Debtor %in% c("Fiji", "Papua New Guinea", "Samoa", "Solomon Islands", "Tonga", "Vanuatu") ~ "Pacific Islands",
  Debtor %in% c("Kosovo", "Moldova") ~ "Europe"
))

selected_creditors <- read_csv("selected_creditors.csv")

selected_creditors <- selected_creditors %>% select(-`Series Code`)
colnames(selected_creditors) <- c("Debtor", "Debtor_Code", "Creditor", "Creditor_Code", "Series", 2000:2019)

selected_creditors <- selected_creditors %>% gather("year", "value", 6:25)

selected_creditors[which(selected_creditors$Series == "External debt stocks, total (DOD, current US$)"), "Series"] <- "Debt_Stocks"
selected_creditors[which(selected_creditors$Series == "Debt forgiveness or reduction (current US$)"), "Series"] <- "Debt_Forgiveness"

selected_creditors <- selected_creditors %>% filter(!is.na(Series))

selected_creditors <- spread(selected_creditors, Series, value)


selected_creditors$Debt_Forgiveness <- as.numeric(selected_creditors$Debt_Forgiveness)
selected_creditors$Debt_Stocks <- as.numeric(selected_creditors$Debt_Stocks)
selected_creditors$year <- as.numeric(selected_creditors$year)

selected_creditors[is.na(selected_creditors)] <- 0

selected_creditors$Debtor <- stringr::str_trim(selected_creditors$Debtor, side = "both")
selected_creditors$Creditor <- stringr::str_trim(selected_creditors$Creditor, side = "both")

selected_creditors <- selected_creditors %>% mutate(Debtor_Region = case_when(
  Debtor %in% c("Angola", "Benin", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep.", "Congo, Rep.", "Cote d'Ivoire", "Djibouti", "Ethiopia", "Gambia, The", "Ghana", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Nigeria", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "Tanzania", "Togo", "Uganda", "Zambia") ~ "Africa",
  Debtor %in% c("Bangladesh", "Bhutan", "Cambodia", "Kyrgyz Republic", "Lao PDR", "Maldives", "Mongolia", "Myanmar", "Nepal", "Pakistan", "Tajikistan", "Timor-Leste", "Uzbekistan") ~ "Asia",
  Debtor %in% c("Afghanistan", "Yemen, Rep.") ~ "Middle East",
  Debtor %in% c("Guyana", "Haiti", "Honduras", "Nicaragua") ~ "South & Central America",
  Debtor %in% c("Dominica", "Grenada", "St. Lucia", "St. Vincent and the Grenadines") ~ "The Caribbeans",
  Debtor %in% c("Fiji", "Papua New Guinea", "Samoa", "Solomon Islands", "Tonga", "Vanuatu") ~ "Pacific Islands",
  Debtor %in% c("Kosovo", "Moldova") ~ "Europe"
))

```


### International Debt Flows

Given the major blow that COVID-19 has dealt to the world’s poorest countries, in 2020, the World Bank and the International Monetary Fund established the Debt Service Suspension Initiative with the G-20. Under this initiative, which has been extended through December 2021, 73 countries are eligible for a temporary suspension of debt-service payments owed to their official bilateral creditors. 

Part of this initiative includes greater debt transparency. For the first time last year, the World Bank released the breakdown of individual creditor countries. Previously, such data was only available at a generalized “creditor region” level. This newly-released database provides us with a lot of insight on the vast network of debt flows between debtor and creditor nations. 

This section will explore international debt flows and the relationships between debtors and creditors. We will first look at the overall patterns of debt levels over time. Then, using the newly released data from the World Bank, we will examine the breakdown of creditors, including countries and multilateral organizations. Finally, we will explore the entire network of debtor nations and their creditors. The data shows us that global debt has increased drastically in the past two decades, and this increase is most significant for Asian countries. On the creditor side, the most striking trend comes from the dramatic increase in lending from China. The international debt landscape is expected to continue evolving over time and governments and policy analysts should continue to keep a close eye on these dynamics.

Data source: International Debt Statistics (The World Bank, 2021)
https://databank.worldbank.org/source/international-debt-statistics:-dssi

Note: All debt levels in the following visualizations are denominated in current US$

-------------------------------------
### Total debt per region (2000-2019)

Firstly, I wanted to get an overview of how debt levels have changed over time. Here we can see that debtor countries from Asia and Africa have experienced a significant rise in total debt levels over the past two decades, compared to other regions. 

```{r, warning=FALSE, message=FALSE}
ggplotly(debt_series %>% group_by(Debtor_Region, Year) %>% summarize(total_debt_bil = sum(Debt_Stocks)/10^9 %>% round(digits = 2), mean_debt_bil = mean(Debt_Stocks)/10^9 %>% round(digits = 2)) %>% ggplot() + geom_line(aes(x = Year, y = total_debt_bil, color = Debtor_Region)) + labs(y = "Total debt (billions of US$)", title = "Total debt per region over time") + theme_minimal())
```
-------------------------------------
### Mean debt per region (2000-2019)

To account for the different group sizes (e.g. half of the debtor nations are from Africa, which would disproportionately inflate the total amount of debt in Africa), it might make more sense to compare average debt levels across regions instead. Here, the picture has changed - mean debt levels in Asia have risen at a much greater rate than the other regions. All regions have experienced an increase in mean debt level, with the exception of the Caribbean nations whose mean debt levels have remained relatively constant. 

```{r, warning=FALSE, message=FALSE}
ggplotly(debt_series %>% group_by(Debtor_Region, Year) %>% summarize(total_debt_bil = sum(Debt_Stocks)/10^9 %>% round(digits = 2), mean_debt_bil = mean(Debt_Stocks)/10^9 %>% round(digits = 2)) %>% ggplot() + geom_line(aes(x = Year, y = mean_debt_bil, color = Debtor_Region)) + labs(y = "Mean debt (billions of US$)", title = "Mean debt per region over time") + theme_minimal())

```

Row {data-height=650}
-------------------------------------

### Total lending among top creditors (2000-2019)

Next, I wanted to visualize how the breakdown of individual creditors has changed over time. The line graph here shows that total lending has increased significantly for organizations like the World Bank and Asian Development Bank. In terms of creditor countries, we see a drastic increase in lending from China, while the US and France have decreased their total lending. 

```{r, warning=FALSE, message=FALSE}
creditors_years <- selected_creditors %>% group_by(Creditor, year) %>% summarize(total_lending_bil = sum(Debt_Stocks)/10^9)


ggplotly(ggplot(creditors_years) + geom_line(aes(x = year, y = total_lending_bil, color = Creditor)) + labs(x = "Year", y = "Total lending (billions of US$)", title = "Total lending over time (top creditors)") + theme_minimal()) 

```


Row {data-height=350}
-------------------------------------
### Breakdown of top creditors (2000)

This pattern can also be visualized through the next two pie charts, which compares the breakdown of top 20 creditors for 2000 vs 2019. The most significant change comes from China, which was represented by a small slice of the pie in 2000 and has jumped to be the top creditor nation in 2019. This is no surprise given China’s increasing investments in developing countries such as through the Belt and Road Initiative and other debt diplomacy arrangements. In contrast, countries which took up a larger portion of the pie in 2000 such as France. Russia and the US are now represented by a much smaller slice. 

```{r, warning=FALSE, message=FALSE}
cols <- RColorBrewer::brewer.pal(8, "Dark2")
debt_2000 <- dssi %>% filter(Year == 2000)
debt_2019 <- dssi %>% filter(Year == 2019)

top_creditors_2000 <- debt_2000 %>% filter(!Creditor %in% c("World", "Multiple Lenders", "Other Multiple Lenders", "Other Multilaterals", "Bondholders", "Other Bilateral")) %>% group_by(Creditor) %>% summarize(total_debt_bil = sum(Debt_Stocks)/10^9 %>% round(digits = 3)) %>% arrange(desc(total_debt_bil)) %>% head(n = 20)

top_creditors_2019 <- debt_2019 %>% filter(!Creditor %in% c("World", "Multiple Lenders", "Other Multiple Lenders", "Other Multilaterals", "Bondholders", "Other Bilateral")) %>% group_by(Creditor) %>% summarize(total_debt_bil = sum(Debt_Stocks)/10^9 %>% round(digits = 3)) %>% arrange(desc(total_debt_bil)) %>% head(n = 20) 

top_creditors_2000 %>% hchart("pie", hcaes(x = Creditor, y = round(total_debt_bil, digits = 1)), name = "Total Lending (billions of US$)") %>% hc_title(text = "Top creditors in 2000")  %>% hc_caption(text = "Data: The World Bank (2021)") %>% hc_colors(cols)

```

Row {data-height=350}
-------------------------------------
### Breakdown of top creditors (2019)
```{r, warning=FALSE, message=FALSE}
top_creditors_2019 %>% hchart("pie", hcaes(x = Creditor, y = round(total_debt_bil, digits = 1)), name = "Total Lending (billions of US$)") %>% hc_title(text = "Top creditors in 2019")  %>% hc_caption(text = "Data: The World Bank (2021)") %>% hc_colors(cols)

```


-------------------------------------

### Debtor-Creditor Network (2019)

Lastly, this visualization shows the network between all debtors and creditors. The size of the nodes is proportional to the total debt levels (in 2019) for that particular country or organization, and the width of the arrows is proportional to the amount of debt flows between two particular nodes. I have also tried to color the nodes in accordance to their geographical region (e.g. countries in Asia/Oceania/Middle East are shades of red and orange, while countries in the Americas/Caribbeans are shades of blue). 

China, for instance, lends to countries in Africa, Asia and Oceania, whereas regional banks are more targeted, such as the Inter-American Development Bank which only lends to nations in South and Central America. Interestingly, Pakistan borrows mostly from European countries. Click on the individual nodes for more information on total debt/lending levels. 


```{r, warning=FALSE, message=FALSE}
links_2019 <- debt_2019 %>% select(Debtor, Creditor, Debt_Stocks) %>% filter(Debt_Stocks != 0) %>% filter(!Creditor %in% c("Other Bilateral", "Other Multiple Lenders", "Other Multilaterals", "World", "Multiple Lenders", "Bondholders"))

links_2019 <- links_2019[, c(2, 1, 3)]

links_2019$Debt_Stocks <- links_2019$Debt_Stocks/10^9 

debtors_2019 <- links_2019 %>% group_by(Debtor) %>% summarize(size = sum(Debt_Stocks))
debtors_2019$group <- "Debtor"
debtors_2019 <- debtors_2019 %>% rename(name = Debtor)

creditors_2019 <- links_2019 %>% group_by(Creditor) %>% summarize(size = sum(Debt_Stocks))
creditors_2019$group <- "Creditor"
creditors_2019 <- creditors_2019 %>% rename(name = Creditor)

nodes_2019 <- rbind(debtors_2019, creditors_2019)

nodes_2019 <- as.data.frame(nodes_2019)
links_2019 <- as.data.frame(links_2019)

nodes_2019$id <- 1:nrow(nodes_2019)

nodes_2019 <- nodes_2019 %>% mutate(region = case_when(
  name %in% c("Angola", "Benin", "Burkina Faso", "Burundi", "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", "Congo, Dem. Rep.", "Congo, Rep.", "Cote d'Ivoire", "Djibouti", "Ethiopia", "Gambia, The", "Ghana", "Guinea", "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Madagascar", "Malawi", "Mali", "Mauritania", "Mozambique", "Niger", "Nigeria", "Rwanda", "Sao Tome and Principe", "Senegal", "Sierra Leone", "Somalia", "Tanzania", "Togo", "Uganda", "Zambia", "Cote D`Ivoire, Republic Of", "Libya", "Mauritius", "South Africa") ~ "Africa",
  name %in% c("Bangladesh", "Bhutan", "Cambodia", "Kyrgyz Republic", "Lao PDR", "Maldives", "Mongolia", "Myanmar", "Nepal", "Pakistan", "Tajikistan", "Timor-Leste", "Uzbekistan", "China", "Hong Kong", "India", "Japan", "Korea, Republic Of", "Kuwait", "Malaysia", "Singapore", "Sri Lanka", "Thailand") ~ "Asia",
  name %in% c("Afghanistan", "Yemen, Rep.", "Bahrain", "Egypt", "Iran, Islamic Republic Of", "Israel", "Saudi Arabia", "United Arab Emirates") ~ "Middle East",
  name %in% c("Guyana", "Haiti", "Honduras", "Nicaragua", "Brazil", "Venezuela, Republic Bolivarian") ~ "South & Central America",
  name %in% c("Dominica", "Grenada", "St. Lucia", "St. Vincent and the Grenadines", "Bahamas", "Barbados", "St. Kitts And Nevis", "Trinidad & Tobago", "St. Vincent & The Grenadines") ~ "The Caribbeans",
  name %in% c("Canada", "United States") ~ "North America", 
  name %in% c("Fiji", "Papua New Guinea", "Samoa", "Solomon Islands", "Tonga", "Vanuatu", "Australia") ~ "Oceania",
  name %in% c("Kosovo", "Moldova", "Argentina", "Austria", "Belarus", "Belgium", "Czech Republic", "Denmark", "Finland", "France", "Germany, Fed.Rep. Of", "Greece", "Hungary", "Ireland", "Italy", "Netherlands", "Norway", "Poland", "Portugal", "Russian Federation", "Serbia", "Slovenia", "Spain", "Sweden", "Switzerland", "Turkey", "United Kingdom") ~ "Europe",
  name %in% c("African Dev. Bank", "Asian Dev. Bank", "Inter-American Dev. Bank", "International Monetary Fund", "World Bank-IBRD", "World Bank-IDA") ~ "Organizations"
))


links_2019 <- left_join(links_2019, nodes_2019 %>% select(name, id), by = c("Creditor" = "name"))
links_2019 <- left_join(links_2019, nodes_2019 %>% select(name, id), by = c("Debtor" = "name"))

links_2019 <- links_2019 %>% rename(source = id.x, target = id.y)

links_2019$source <- links_2019$source - 1
links_2019$target <- links_2019$target - 1


```

```{r, warning=FALSE, message=FALSE}
script <- 'alert("Name: " + d.name + "\\n" + "Status: " + d.status + "\\n" + "Region: " + d.group + "\\n" + "Total debt/lending (billions of US$): " + d.size);'

network_2019 <- forceNetwork(Links = links_2019, 
                   Nodes = nodes_2019, 
                   Source = "source",
                   Target = "target", 
                   Value = "Debt_Stocks", 
                   NodeID = "name",
                   Nodesize = "size",
                   Group = "region", 
             fontSize = 20,
             linkDistance = 80,
                   opacity = 0.9, zoom = FALSE, legend = TRUE, arrows = TRUE, height = 500, width = 1000, bounded = TRUE, clickAction = script,
             colourScale = JS('d3.scaleOrdinal()
           .range(["#ce8000", "#619e8d", "#fa8072", "#584a91", "#ff748c", "6897bb", "a75572", "c7c9c7", "0a75ad"]);'))



network_2019$x$nodes$status <- nodes_2019$group
network_2019$x$nodes$size <- nodes_2019$size %>% round(digits = 3)


## Click on the node to see info popup
network_2019
```





Appendix
===================================== 
### Appendix


```{r, error = TRUE}
#line chart
usa_chart <- ggplot(usa, aes(x = year, y = debt_gdp)) +
  xlab("Year") +
  ylab("Debt-GDP") +
  theme_minimal(base_size = 14, base_family = "Georgia")+
  geom_point() +
  geom_line()

plot(usa_chart)

usa_chart_interactive <- ggplotly(usa_chart)
print(usa_chart_interactive)


h
```


